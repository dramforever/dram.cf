<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The flea compiler</title>

<script src="vendor/decimal.min.js"></script>
<script src="parser.js"></script>
<script src="compiler.js"></script>

<style>
    body {
        padding-left: 52%;
    }

    #input {
        position: fixed;
        left: 0px;
        top: 0px;
        width: 50%;
        height: 100%;
        padding: 15px;
    }

    #output {
        font-family: Consolas, monospace;
        border: 2px solid black;
        padding: 10px;
        margin-top: 10px;
        overflow: auto;
    }
</style>

<textarea id="input">{expr test}

x = in(1)
p = s((x + 1e-30) &lt;&lt; 500) &lt;&lt; 152 
y = s((x &gt;&gt; 150) + p)
r  = x + ((-y + 0.5) &lt;&lt; 153) + p
out(r)

{cse test}

x = s(in(1))
out(x)

u = in(1) + in(1)
out(u)

v = s(in(1) + in(1))
out(v)

k = 1 + 4
p = 2 + 3
out(k)
out(p)

m_1 = in(1) ? 5
m_2 = in(1) ? 6
m_3 = in(1) ? 7
m_4 = s(in(1)) ? (in(1) + in(1))

out(m_1)
out(m_2)
out(m_3)
</textarea>

<style>
    #show-help:checked + label + pre {
        display: block;
    }
    #show-help:not(:checked) + label + pre {
        display: none;
    }
</style>

<input type="checkbox" name="show-help" id="show-help"/>
<label for="show-help"><code>Show help</code></label>

<pre id="help">Comments are {pascal style}, no nesting

Commands:
<b>var = expr</b> assign var to expr
<b>out(var)</b> output var

Expressions (precedence tight to loose):
<b>in(id)</b> Input (id is a integer)
<b>s(a)</b> Sigmoid
<b>- x</b> Negation
<b>a &lt;&lt; b</b>, <b>a &gt;&gt; b</b> Shift (b must be a constant)
<b>a * b</b> Multiply
<b>a + b</b> Plus (Choice between + and C is automatic)
<b>a ? b</b> Compare, <b>a ^ b</b> Max

Implemented optimizations:
Common sub-expression elimination

Decimal arith using <a href="http://mikemcl.github.io/decimal.js/">decimal.js</a>
Parsed using <a href="http://pegjs.org">pegjs</a>

<b>Warning: precision is not very good with sigmoid</b></pre>

<pre id="output"></pre>

<pre><a id="link" href="#">[Share your fleas]</a></pre>

<script>
    var button = document.getElementById("compile");
    var input = document.getElementById("input");
    var output = document.getElementById("output");
    var link = document.getElementById("link");

    function writeOutput(lst) {
        while(output.childNodes.length)
            output.removeChild(output.childNodes[0]);
        for (var i = 0; i < lst.length; i ++)
            if (lst[i] != "") {
                var ele = document.createElement("div");
                ele.textContent = lst[i];
                output.appendChild(ele);
            }
    }

    function update() {
        var str = input.value;
        link.href = "#" + encodeURIComponent(input.value);
        try {
            output.textContent = compile(input.value).join("\n");
        } catch(e) {
            output.textContent = [
                "Error:\n",
                e.toString(),
                e.line ? "\nAt line " + e.line.toString() + (e.column ? ", column " + e.column.toString() : "") : "",
                e.id ? "\nAt command " + e.id.toString() : ""].join("");
        }
    }

    if (location.hash.length > 1) {
        input.value = decodeURIComponent(location.hash.slice(1));
    }

    update();
    setInterval(update, 1000);
</script>

<!-- vim: sw=4 ts=4 et si
-->

