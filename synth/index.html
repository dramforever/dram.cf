<title>Synth</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="../styles/default.css">

<style>
    .box {
        /* display: ; */
        margin: 5px;
        padding: 3px;
        border: 1px solid black;
    }

    #notes {
        min-height: 60px;
        white-space: pre;
    }

    #start {
        text-align: center;
    }
</style>

<div class="box" id="start">Play <sub>(Shift + Enter)</sub></div>

<div class="box" id="notes" contenteditable autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></div>

<div class="box">
    <ul>
        <li><b>cdefgab</b> notes</li>
        <li><b>&gt; &lt;</b> up/down octave</li>
        <li><b>p q</b> up/down semitone</li>
        <li><b># v</b> sharp/flat</li>
        <li><b>-</b> duration +1 beat</li>
        <li><b>.</b> duration 1.5x</li>
        <li><b>(</b>...<b>)</b> comments</li>
        <li><b>[</b>...<b>]</b> pragmas</li>
        <ul>
            <li><b>[dur 0.3]</b> beat length</li>
            <li><b>[dur]</b> reset beat length</li>
        </ul>
    </ul>
</div>

<script>
    const actx = new AudioContext();
    const osc = actx.createOscillator();
    const gain = actx.createGain();

    osc.type = 'square';

    osc.connect(gain);
    gain.connect(actx.destination);
    gain.gain.value = 0;

    let oscStarted = false;

    const freq = (note) => Math.pow(2, note / 12) * 440;

    function playNotes(notes) {
        if (!oscStarted) {
            oscStarted = true;
            osc.start();
        }

        const time = actx.currentTime;

        osc.frequency.cancelScheduledValues(time);
        gain.gain.cancelScheduledValues(time);

        let t = time;
        for (const note of notes) {
            if (!note.error) {
                if (null !== note.num) {
                    gain.gain.setValueAtTime(1, t);
                    gain.gain.linearRampToValueAtTime(0.2, t + (7 / 8) * note.dur);
                    gain.gain.setTargetAtTime(0, t + (7 / 8) * note.dur, note.dur / 3);

                    osc.frequency.setValueAtTime(freq(note.num), t);
                }

                t += note.dur;
            }
        }
        gain.gain.setValueAtTime(0, t);
    }

    function parseNotes(str) {
        const names = 'c d ef g a b';
        const result = [];

        let noteBase = -9;
        let durUnit = 0.3;

        let pos = 0;
        const peek = () => str[pos];

        while (str[pos]) {
            if ('cdefgabx'.includes(str[pos])) {
                const note = {
                    num: ('x' === str[pos])
                        ? null
                        : (noteBase + names.indexOf(str[pos])),
                    dur: durUnit,
                    first: pos,
                    last: pos
                };
                pos++;

                for (; '#v.-/'.includes(str[pos]); pos++) {
                    if ('#' === str[pos]) note.num += 1;
                    else if ('v' === str[pos]) note.num -= 1;
                    else if ('-' === str[pos]) note.dur += durUnit;
                    else if ('.' === str[pos]) note.dur *= 1.5;
                    else if ('/' === str[pos]) note.dur *= 0.5;
                }
                note.last = pos;
                result.push(note);
            } else if ('><pq'.includes(str[pos])) {
                const delta = { '>': 12, '<': -12, 'p': 1, 'q': -1 };
                noteBase += delta[str[pos]];
                pos ++;                
            } else if ('(' === str[pos]) {
                // Comment
                pos ++;
                for (let count = 1; str[pos] && count > 0; pos ++) {
                    if (str[pos] == '(') count ++;
                    else if (str[pos] == ')') count --;
                }
            } else if ('[' === str[pos]) {
                // Pragma
                const res = /^\[(?<expr>.*?)\]/.exec(str.substr(pos));


                if (null === res) {
                    // Unclosed    
                    result.push({
                        error: str[pos],
                        first: pos,
                        last: pos + 1
                    });
                    pos ++;
                } else {
                    const cmd = res.groups.expr.split(' ');

                    done: {
                        if (cmd[0] == 'dur') {
                            if (cmd.length == 2 && 0 < +cmd[1]) {
                                durUnit = +cmd[1];
                                break done;
                            } else if (cmd.length == 1) {
                                durUnit = 0.3;
                                break done;
                            }
                        }

                        // No command match

                        result.push({
                            error: res[0],
                            first: pos,
                            last: pos + res[0].length
                        });
                    }

                    pos += res[0].length;
                }
            } else if (' \n\t'.includes(str[pos])) {
                // Ignore
                pos ++;
            } else {
                result.push({
                    error: str[pos],
                    first: pos,
                    last: pos + 1
                });
                pos ++;
            }
        }

        return result;
    }

    
    const startBtn = document.querySelector('#start');
    const notesBox = document.querySelector('#notes');

    notesBox.textContent = `(Bad Apple!! abridged)

p

defga- >dc<a-d- agfe
defga- gfedefedce
defga- >dc<a-d- agfe
defga- gfe-f-g-a-

>cd<aga- ga>cd<aga-
gagfecd- cdefgad-
ga>cd<aga- ga>cd<aga-
>defedc<a- gagfecd-

p

ga>cd<aga- ga>cd<aga-
gagfecd- cdefgad-
ga>cd<aga- ga>cd<aga-
>defedc<a- gagfecd-`;

    notesBox.focus();

    const start = () => playNotes(parseNotes(notesBox.textContent));

    startBtn.onclick = start;

    window.onkeypress = (event) => {
        if ('Enter' === event.code && (event.ctrlKey || event.shiftKey || event.metaKey)) {
            event.preventDefault();
            start();
        }
    };
</script>