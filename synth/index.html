<title>Synth</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="../styles/default.css">

<style>
    .box {
        /* display: ; */
        margin: 5px;
        padding: 3px;
        border: 1px solid black;
    }

    #notes {
        min-height: 60px;
        white-space: pre;
    }

    #start {
        text-align: center;
    }
</style>

<div class="box" id="start">Play <sub>(Shift + Enter)</sub></div>

<div class="box" id="notes" contenteditable autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></div>

<div class="box">
    <ul>
        <li><b>cdefgab</b>: notes</li>
        <li><b>&gt; &lt;</b>: up/down octave</li>
        <li><b>p q</b>: up/down semitone</li>
        <li><b># v</b>: sharp/flat</li>
        <li><b>-</b>: duration +1 beat</li>
        <li><b>.</b>: duration 1.5x</li>
        <li><b>(</b>...<b>)</b>: comments</li>
    </ul>
</div>

<script>
    const actx = new AudioContext();
    const osc = actx.createOscillator();
    const gain = actx.createGain();

    osc.type = 'square';

    osc.connect(gain);
    gain.connect(actx.destination);
    gain.gain.value = 0;

    let oscStarted = false;

    const freq = (note) => Math.pow(2, note / 12) * 440;

    function playNotes(notes) {
        if (!oscStarted) {
            oscStarted = true;
            osc.start();
        }

        const time = actx.currentTime;

        osc.frequency.cancelScheduledValues(time);
        gain.gain.cancelScheduledValues(time);

        let t = time;
        for (const note of notes) {
            if (!note.error) {
                gain.gain.setValueAtTime(1, t);
                gain.gain.linearRampToValueAtTime(0.2, t + (7 / 8) * note.dur * 0.3);
                gain.gain.setTargetAtTime(0, t + (7 / 8) * note.dur * 0.3, note.dur * 0.1);

                osc.frequency.setValueAtTime(freq(note.num), t);

                t += note.dur * 0.3;
            }
        }
    }

    function parseNotes(str) {
        str = str.replace(
            /\([^)]*\)/gm,
            (x) => x.replace(/./gm, ' '));

        const names = 'c d ef g a b';
        let noteBase = -9;
        const notes = [];
        for (const [i, c] of [].entries.call(str)) {
            if ('cdefgab'.includes(c)) {
                notes.push({
                    num: noteBase + names.indexOf(c),
                    dur: 1,
                    first: i,
                    last: i
                });

            } else if ('>' === c) {
                noteBase += 12;

            } else if ('<' === c) {
                noteBase -= 12;

            } else if ('p' === c) {
                noteBase += 1;

            } else if ('q' === c) {
                noteBase -= 1;

            } else if ('#v.-'.includes(c)) {
                if (notes.length == 0 || notes[notes.length - 1].error) {
                    notes.push({
                        error: c,
                        first: i,
                        last: i
                    });

                } else {
                    const prev = notes[notes.length - 1];
                    prev.last = i;

                    if ('#' === c) prev.num += 1;
                    else if ('v' === c) prev.num -= 1;
                    else if ('-' === c) prev.dur += 1;
                    else if ('.' === c) prev.dur *= 1.5;

                }
            } else if (' \n\t'.includes(c)) {
                // Ignore
            } else {
                notes.push({
                    error: c,
                    first: i,
                    last: i
                });
            }
        }

        return notes;
    }

    
    const startBtn = document.querySelector('#start');
    const notesBox = document.querySelector('#notes');

    notesBox.textContent = `(Bad Apple!! abridged)

p

defga- >dc<a-d- agfe
defga- gfedefedce
defga- >dc<a-d- agfe
defga- gfe-f-g-a-

>cd<aga- ga>cd<aga-
gagfecd- cdefgad-
ga>cd<aga- ga>cd<aga-
>defedc<a- gagfecd-

p

ga>cd<aga- ga>cd<aga-
gagfecd- cdefgad-
ga>cd<aga- ga>cd<aga-
>defedc<a- gagfecd-`;

    notesBox.focus();

    const start = () => playNotes(parseNotes(notesBox.textContent));

    startBtn.onclick = start;

    window.onkeypress = (event) => {
        if ('Enter' === event.code && (event.ctrlKey || event.shiftKey || event.metaKey)) {
            start();
            event.preventDefault();
        }
    };
</script>